<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>All Listings â€” LaboConnect</title>
  <link rel="stylesheet" href="/css/global.css">
  <link rel="stylesheet" href="/css/home.css">
</head>
<body>
  <div id="header-import"></div>

  <main class="wrap">
    <section style="padding:22px 0">
      <h2 class="section-title">All Approved Listings</h2>
      <p class="lead">Browse all approved property listings. Use the search and filters to narrow results.</p>

      <div style="display:flex;gap:12px;margin-top:12px;flex-wrap:wrap;align-items:center">
        <input id="searchInput" placeholder="Search by title or description" style="flex:1;padding:10px;border-radius:10px;border:1px solid rgba(15,23,42,0.08)">
        <select id="filterType" style="padding:10px;border-radius:10px;border:1px solid rgba(15,23,42,0.08)">
          <option value="">All Types</option>
          <option value="For Lease">For Lease</option>
          <option value="For Sale">For Sale</option>
        </select>
        <button class="btn btn-primary" id="applyFilters">Apply</button>
        <button class="btn btn-ghost" id="resetFilters">Reset</button>
      </div>

      <div class="grid" id="listingsGrid" style="margin-top:16px"></div>

      <div id="listingsEmpty" class="muted" style="text-align:center;margin-top:18px;display:none">No listings found.</div>
    </section>
  </main>

  <div id="footer-placeholder"></div>

  <script src="/js/global.js"></script>
  <script src="/js/home.js"></script>
  <script>
    async function loadAllListings() {
      const grid = document.getElementById('listingsGrid');
      const empty = document.getElementById('listingsEmpty');
      grid.innerHTML = '';
      empty.style.display = 'none';
      try {
        const resp = await fetch('/api/approved-listings');
        if (!resp.ok) throw new Error('Failed to fetch');
        const data = await resp.json();
        window._allListings = Array.isArray(data) ? data : [];
        renderListings(window._allListings);
      } catch (err) {
        console.error(err);
        empty.textContent = 'Could not load listings.';
        empty.style.display = 'block';
      }
    }

    function renderListings(items) {
      const grid = document.getElementById('listingsGrid');
      const empty = document.getElementById('listingsEmpty');
      grid.innerHTML = '';
      if (!items || items.length === 0) {
        empty.textContent = 'No listings found.';
        empty.style.display = 'block';
        return;
      }
      empty.style.display = 'none';

      items.forEach(item => {
        const card = document.createElement('article');
        card.className = 'card listing-card';
        const img = item.image_url ? `style="background-image:url('${item.image_url}')"` : '';
        card.innerHTML = `
          <div class="property-photo" aria-hidden="true" ${img}></div>
          <div class="tags"><span class="tag">${item.type || 'Listing'}</span></div>
          <div class="title">${item.title || 'Untitled'}</div>
          <div class="muted description">${item.description || ''}</div>
          <div class="listing-meta">
            <div class="listing-price">${item.price || 'Price on request'}</div>
            <div class="listing-stats muted">${item.size ? (item.size + ' sqm') : ''}</div>
          </div>
          <div class="listing-actions">
              <button class="btn btn-primary" onclick="openInquiry(${item.id}, '${(item.title||'Listing').replace(/'/g, "\\'")}')">Send Inquiry</button>
              <button class="btn btn-ghost" onclick="viewDetailsById(${item.id})">View Details</button>
            </div>
        `;
        grid.appendChild(card);
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadAllListings();

      document.getElementById('applyFilters').addEventListener('click', () => {
        const q = document.getElementById('searchInput').value.trim().toLowerCase();
        const type = document.getElementById('filterType').value;
        let items = (window._allListings || []).slice();
        if (type) items = items.filter(i => (i.type || '').toLowerCase() === type.toLowerCase());
        if (q) items = items.filter(i => ((i.title||'') + ' ' + (i.description||'')).toLowerCase().includes(q));
        renderListings(items);
      });

      document.getElementById('resetFilters').addEventListener('click', () => {
        document.getElementById('searchInput').value = '';
        document.getElementById('filterType').value = '';
        renderListings(window._allListings || []);
      });
    });
  </script>
</body>
</html>
